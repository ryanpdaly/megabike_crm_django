{% extends 'common/base.html' %}
{% load static %}
{% load insurance_filters %}

{% block title %}
  MegabikeCRM: Versicherung
{% endblock %}

{% block header %}
  <h1 class="h2 mb-0 text-gray-800">Versicherung: Schadensmeldungen</h1>
  <a href="{% url 'insurance:schaden-new' %}" class="d-none d-sm-inline-block btn btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Schadensmeldung erstellen </a>
{% endblock %}

{% block content %}
  <div>
    <a {% if filter == 'all' %}
      class="btn btn-outline-success btn-sm shadow-sm active" aria-pressed="true"
    {% else %}
      class="btn btn-secondary btn-sm shadow-sm button-sm"
    {% endif %}
      href="{% url 'insurance:schaden-list' filter='all' %}">
      Alle Tickets
    </a>
    <a {% if filter == 'open' %}
      class="btn btn-outline-success btn-sm shadow-sm active" aria-pressed="true"
    {% else %}
      class="btn btn-secondary btn-sm shadow-sm"
    {% endif %}
      href="{% url 'insurance:schaden-list' filter='open' %}">
      Nur Offene Tickets
    </a>
  </div>
  <br/> <!-- This is downright hackish. Fix the damned CSS. -->

    <div class='table-responsive'>
      <table id="dataTable" class="table table-striped table-hover">
        <thead>
          <tr>
            <th scope="col"></th>
            <th scope="col">Schadensnummer</th>            
            <th scope="col">Status</th>
            <th scope="col">Vorgangsnummer</th>
            <th scope="col">Kunde</th>           
            <th scope="col">Zuletzt bearbeitet</th>
          </tr>
        </thead>
        <tbody>
          {% for schaden in schaden_list %}
            {% if filter == 'all' or schaden|insurance_current_status not in erledigt %}
            <tr>
              <th scope="row">
                <a href="{% url 'insurance:schaden-detail' pk=schaden.id%}"
                  {% if schaden|insurance_current_status in erledigt %}
                    class="btn btn-secondary btn-circle btn-sm">
                  <i class="fas fa-check"></i>
                  {% elif schaden|insurance_last_update >= 9 %}
                        class="btn btn-danger btn-circle btn-sm">
                        <i class="fas fa-exclamation-triangle"></i>
                  {% elif schaden|insurance_last_update >= 5 %}
                      class="btn btn-warning btn-circle btn-sm">
                        <i class="fas fa-exclamation-triangle"></i>
                  {% else %}
                      class="btn btn-success btn-circle btn-sm">
                      <i class="fas fa-info-circle"></i>
                  {% endif %}
                </a>
              </th>
              <td><a href="{% url 'insurance:schaden-detail' pk=schaden.id%}" {# create modal to complete basic info + files, button to edit #}>{{ schaden.get_unternehmen_display }}: {{ schaden.schadensnummer }}</a></td>
              <td><a href="#" {# create modal for complete status + file, button to update #}>{{ schaden|insurance_current_status }}</a></td>
              <td>{{ schaden.auftragsnr }}{% if schaden.rechnungsnr %} / {{schaden.rechnungsnr}} {% endif %}</td>
              <td>{{ schaden.kunde.kundennummer }}: {{ schaden.kunde.nachname }}</td>
              <td>vor <b>{{ schaden|insurance_last_update }}</b> Tage</td>
            </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>

  <div class="modal" id="modal" tabindex="-1" role="dialog"></div>
{% endblock %}

{% block javascript %}
  {{ block.super }}
  <link href="{% static 'vendor/datatables/dataTables.bootstrap4.min.css' %}" rel="stylesheet">
    <script src="{% static 'vendor/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'vendor/datatables/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'js/datatables.js' %}"></script>

  <script>
    $('#modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget)
        var form_url = button.data('url')

        var modal = $(this)
        
        $.ajax({
            url: form_url,
            context: document.body,
            async: true,

        }).done(function(response) {
            modal.html(response);
        });
    })
  </script>
{% endblock %}